# -*- Mode: sh

all: $(TARGET)

PROJ = mp
DOCS = AUTHORS README COPYING Changelog mprc.sample

OBJS = \
	mp_core.o \
	mp_synhi.o \
	mp_iface.o \
	gnu_regex.o \
	mp_tags.o \
	mp_wordp.o \
	mp_lang.o \
	mp_conf.o \
	mp_func.o \
	mp_video.o \
	$(LANG_MSG_O) \
	mpv_unix_common.o \
	mpv_curses.o

##################################################################

version:
	@echo $(VERSION)

ChangeLog:
	svn update && svn log > Changelog

.c.o:
	$(CC) $(CFLAGS) `cat config.cflags` -c $<

dep:
	gcc -MM *.c > makefile.depend

mp: $(OBJS)
	$(CC) $(CFLAGS) $(OBJS) `cat config.ldflags` -o $@

mp_lang_m.c:
	po2c po/*.po > mp_lang_m.c

clean:
	rm -f $(TARGET) $(LIB) $(OBJS) *.o tags *.tar.gz wmp.exe

distclean: clean
	rm -f mp_lang_m.* config.h config.cflags config.ldflags makefile.opts Makefile doc/*.html

docs:
	mkdir -p doc
	mp_doccer *.c -o doc/mp_api -f html1 \
		-t "The Minimum Profit API ($(VERSION))" \
		-a 'Angel Ortega - angel@triptico.com'
	grutatxt -m man -t "Minimum Profit" < doc/mp_man.txt > doc/mp.1
	grutatxt -dl -t "Minimum Profit Man Page" < doc/mp_man.txt > doc/mp_man.html

dist: distclean docs ChangeLog mp_lang_m.c mp_func_i.h po/minimum-profit.pot build-mo
	cd .. ; ln -s $(PROJ) $(PROJ)-$(VERSION); \
	tar czvf $(PROJ)-$(VERSION)/$(PROJ)-$(VERSION).tar.gz --exclude=.svn $(PROJ)-$(VERSION)/* ; \
	rm $(PROJ)-$(VERSION)

install: build-mo $(INSTALL_MSG)
	mkdir -p $(PREFIX)/bin
	install $(TARGET) $(PREFIX)/bin/$(APPNAME)
	mkdir -p $(PREFIX)/share/doc/$(APPNAME)
	install -m 644 $(DOCS) $(PREFIX)/share/doc/$(APPNAME)
	mkdir -p $(PREFIX)/share/man/man1
	install -m 644 doc/mp.1 $(PREFIX)/share/man/man1/$(APPNAME).1

po/minimum-profit.pot:
	xgettext -o $@ --keyword=L --keyword=LL mp*.c mp_func_i.h

update-po:
	for a in po/*.po ; do \
		xgettext --omit-header -j -o $$a --keyword=L --keyword=LL mp*.c mp_func_i.h ; \
	done

.po.mo:
	msgfmt -o $@ $<

build-mo:
	for a in po/*.po ; do \
		B=`basename $$a .po` ; \
		msgfmt -o po/$$B.mo $$a ; \
	done

install-mo:
	for a in po/*.mo ; do \
		B=`basename $$a .mo` ; \
		mkdir -p $(PREFIX)/share/locale/$$B/LC_MESSAGES ; \
		install -m 644 $$a $(PREFIX)/share/locale/$$B/LC_MESSAGES/minimum-profit.mo ; \
	done

